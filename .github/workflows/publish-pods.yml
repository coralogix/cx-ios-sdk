name: Publish CocoaPods

permissions:
  contents: read

on:
  release:
    types: [published]

jobs:
  publish-pods:
    runs-on: macos-latest
    env:
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      TAG_RAW: ${{ github.event.release.tag_name || github.ref_name }}

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x ./verify_podspec_versions.sh

      - name: Verify release tag matches podspec versions
        run: |
          set -euo pipefail
          echo "Using tag: ${TAG_RAW}"
          ./verify_podspec_versions.sh "${TAG_RAW}"

      # Set up Ruby (required for CocoaPods)
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2' # Specify a Ruby version compatible with CocoaPods
          bundler-cache: true

      # Install CocoaPods
      - name: Install CocoaPods
        run: gem install cocoapods

      # Set up CocoaPods Trunk authentication
      - name: Authenticate with CocoaPods Trunk
        run: |
           set -euo pipefail
           test -n "${COCOAPODS_TRUNK_TOKEN:-}" || { echo "Missing COCOAPODS_TRUNK_TOKEN"; exit 1; }
           echo "Validating CocoaPods Trunk token..."
           pod trunk me || { echo "Invalid or missing COCOAPODS_TRUNK_TOKEN"; exit 1; }

      # Push CoralogixInternal.podspec
      - name: Push CoralogixInternal.podspec
        run: |
          set -euo pipefail
          echo "Target version: ${TAG_RAW}"
          if pod trunk info CoralogixInternal | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
            echo "‚ÑπÔ∏è  CoralogixInternal ${TAG_RAW} already on Trunk. Skipping push."
          else
            echo "üöÄ Pushing CoralogixInternal.podspec..."
            if pod trunk push CoralogixInternal.podspec --allow-warnings --skip-tests --verbose; then
              echo "‚úÖ  CoralogixInternal.podspec pushed!"
            else
              echo "‚ö†Ô∏è  Push failed; re-checking for 409 duplicate..."
              if pod trunk info CoralogixInternal | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
                echo "‚ÑπÔ∏è  CoralogixInternal ${TAG_RAW} appears published. Continuing."
              else
                exit 1
              fi
            fi
          fi

      # Clear CocoaPods cache
      - name: Clear CocoaPods cache
        run: |
          echo "üßπ Clearing CocoaPods cache..."
          pod cache clean --all
          echo "‚úÖ Cache cleared."

      # Wait for CoralogixInternal availability
      - name: Wait for CoralogixInternal availability
        run: |
          set -euo pipefail
          if [ -z "${TAG_RAW}" ]; then
            echo "‚ùå Could not parse version from CoralogixInternal.podspec"
            exit 1
          fi
          echo "‚è≥ Waiting for CoralogixInternal "${TAG_RAW}" to appear on Trunk..."
          timeout=900
          elapsed=0
          until pod trunk info CoralogixInternal | grep -q " - ${TAG_RAW}"; do
            if [ "$elapsed" -ge "$timeout" ]; then
              echo "‚ùå Timeout: CoralogixInternal ${TAG_RAW} not available after $timeout seconds."
              exit 1
            fi
            echo "‚è≥ Not yet available, waiting 30 seconds..."
            sleep 30
            elapsed=$((elapsed + 30))
          done
          echo "‚úÖ CoralogixInternal ${TAG_RAW} is now available on Trunk!"
          
      # Push SessionReplay.podspec
      - name: Push SessionReplay.podspec
        run: |
          set -euo pipefail
          echo "Target version: ${TAG_RAW}"
          if pod trunk info SessionReplay | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
            echo "‚ÑπÔ∏è SessionReplay ${TAG_RAW} already on Trunk. Skipping push."
          else
            echo "üöÄ Pushing SessionReplay.podspec..."
            if pod trunk push SessionReplay.podspec --allow-warnings --skip-tests --verbose; then
              echo "‚úÖ SessionReplay.podspec pushed!"
            else
              echo "‚ö†Ô∏è Push failed; re-checking for 409 duplicate..."
              if pod trunk info SessionReplay | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
                echo "‚ÑπÔ∏è SessionReplay ${TAG_RAW} appears published. Continuing."
              else
                exit 1
              fi
            fi
          fi

      # Push Coralogix.podspec
      - name: Push Coralogix.podspec
        run: |
          set -euo pipefail
          echo "Target version: ${TAG_RAW}"
          if pod trunk info Coralogix | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
            echo "‚ÑπÔ∏è Coralogix ${TAG_RAW} already on Trunk. Skipping push."
          else
            echo "üöÄ Pushing Coralogix.podspec..."
            if pod trunk push Coralogix.podspec --allow-warnings --skip-tests --verbose; then
              echo "üéâ Coralogix.podspec pushed successfully! üéâ"
            else
              echo "‚ö†Ô∏è Push failed; re-checking for 409 duplicate..."
              if pod trunk info Coralogix | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
                echo "‚ÑπÔ∏è Coralogix ${TAG_RAW} appears published. Done."
              else
                exit 1
              fi
            fi
          fi