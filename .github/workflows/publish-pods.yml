name: Publish CocoaPods

permissions:
  contents: read

on:
  release:
    types: [published]

jobs:
  publish-pods:
    runs-on: macos-latest
    env:
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      TAG_RAW: ${{ github.event.release.tag_name || github.ref_name }}

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x ./verify_podspec_versions.sh

      - name: Verify release tag matches podspec versions
        run: |
          set -euo pipefail
          echo "Using tag: ${TAG_RAW}"
          ./verify_podspec_versions.sh "${TAG_RAW}"

      # Set up Ruby (required for CocoaPods)
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2' # Specify a Ruby version compatible with CocoaPods
          bundler-cache: true

      # Install CocoaPods
      - name: Install CocoaPods
        run: gem install cocoapods

      # Set up CocoaPods Trunk authentication
      - name: Authenticate with CocoaPods Trunk
        run: |
           set -euo pipefail
           test -n "${COCOAPODS_TRUNK_TOKEN:-}" || { echo "Missing COCOAPODS_TRUNK_TOKEN"; exit 1; }
           echo "Validating CocoaPods Trunk token..."
           pod trunk me || { echo "Invalid or missing COCOAPODS_TRUNK_TOKEN"; exit 1; }

      # Push CoralogixInternal.podspec
      - name: Push CoralogixInternal.podspec
        run: |
          set -euo pipefail
          echo "Target version: ${TAG_RAW}"
          if pod trunk info CoralogixInternal | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
            echo "â„¹ï¸  CoralogixInternal ${TAG_RAW} already on Trunk. Skipping push."
          else
            echo "ğŸš€ Pushing CoralogixInternal.podspec..."
            set +e
            push_output=$(pod trunk push CoralogixInternal.podspec --allow-warnings --skip-tests --verbose 2>&1)
            push_exit_code=$?
            set -e
            
            if [ $push_exit_code -eq 0 ]; then
              echo "âœ… CoralogixInternal.podspec pushed!"
              
              # Wait for CoralogixInternal to become available
              echo "â³ Waiting for CoralogixInternal to be available in CocoaPods Specs..."
              timeout=900
              elapsed=0
              until pod search CoralogixInternal | grep -q "CoralogixInternal"; do
                if [ "$elapsed" -ge "$timeout" ]; then
                  echo "âŒ Timeout: CoralogixInternal not available after $timeout seconds."
                  exit 1
                fi
                echo "â³ CoralogixInternal not yet available, waiting 30 seconds..."
                sleep 30
                elapsed=$((elapsed + 30))
              done
              echo "âœ… CoralogixInternal is now available!"
            else
              if echo "$push_output" | grep -q "Unable to accept duplicate entry"; then
                echo "âš ï¸ Duplicate entry detected for CoralogixInternal, skipping to next phase..."
              else
                echo "âŒ Error pushing CoralogixInternal.podspec:"
                echo "$push_output"
                exit 1
              fi
            fi
          fi

      # Clear CocoaPods cache
      - name: Clear CocoaPods cache
        run: |
          echo "ğŸ§¹ Clearing CocoaPods cache..."
          pod cache clean --all
          echo "âœ… Cache cleared."
          
      # Push SessionReplay.podspec
      - name: Push SessionReplay.podspec
        run: |
          set -euo pipefail
          echo "Target version: ${TAG_RAW}"
          if pod trunk info SessionReplay | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
            echo "â„¹ï¸ SessionReplay ${TAG_RAW} already on Trunk. Skipping push."
          else
            echo "ğŸš€ Pushing SessionReplay.podspec..."
            set +e
            push_output=$(pod trunk push SessionReplay.podspec --allow-warnings --skip-tests --verbose 2>&1)
            push_exit_code=$?
            set -e
            
            if [ $push_exit_code -eq 0 ]; then
              echo "âœ… SessionReplay.podspec pushed!"
            else
              if echo "$push_output" | grep -q "Unable to accept duplicate entry"; then
                echo "âš ï¸ Duplicate entry detected for SessionReplay, skipping to next phase..."
              else
                echo "âŒ Error pushing SessionReplay.podspec:"
                echo "$push_output"
                exit 1
              fi
            fi
          fi

      # Push Coralogix.podspec
      - name: Push Coralogix.podspec
        run: |
          set -euo pipefail
          echo "Target version: ${TAG_RAW}"
          if pod trunk info Coralogix | grep -Eq "^[[:space:]]*-[[:space:]]*${TAG_RAW}([[:space:]]|\(|$)"; then
            echo "â„¹ï¸ Coralogix ${TAG_RAW} already on Trunk. Skipping push."
          else
            echo "ğŸš€ Pushing Coralogix.podspec..."
            set +e
            push_output=$(pod trunk push Coralogix.podspec --allow-warnings --skip-tests --verbose 2>&1)
            push_exit_code=$?
            set -e
            
            if [ $push_exit_code -eq 0 ]; then
              echo "ğŸ‰ Coralogix.podspec pushed successfully! ğŸ‰"
            else
              if echo "$push_output" | grep -q "Unable to accept duplicate entry"; then
                echo "âš ï¸ Duplicate entry detected for Coralogix, skipping..."
              else
                echo "âŒ Error pushing Coralogix.podspec:"
                echo "$push_output"
                exit 1
              fi
            fi
          fi