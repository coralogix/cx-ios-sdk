name: UI Tests

permissions:
  contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  ui-tests:
    name: Run DemoApp UI Tests
    runs-on: macos-15
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode 16.2 if available
        run: |
          if [ -d "/Applications/Xcode_16.2.app" ]; then
            echo "DEVELOPER_DIR=/Applications/Xcode_16.2.app/Contents/Developer" >> $GITHUB_ENV
            sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.1.app" ]; then
            echo "DEVELOPER_DIR=/Applications/Xcode_16.1.app/Contents/Developer" >> $GITHUB_ENV
            sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.0.app" ]; then
            echo "DEVELOPER_DIR=/Applications/Xcode_16.0.app/Contents/Developer" >> $GITHUB_ENV
            sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          else
            echo "Using default Xcode"
          fi

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Verify project structure
        run: |
          set -euo pipefail
          if [ -f "Example/DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
            echo "‚úÖ Found workspace: Example/DemoApp.xcworkspace"
          elif [ -d "Example/DemoApp.xcodeproj" ]; then
            echo "‚úÖ Found project: Example/DemoApp.xcodeproj"
          else
            echo "‚ùå Project/workspace not found in Example/ directory"
            find . -name "*.xcworkspace" -o -name "*.xcodeproj" | head -10
            exit 1
          fi

      - name: Set build configuration
        run: |
          set -euo pipefail
          if [ -f "Example/DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
            echo "BUILD_TYPE=-workspace" >> $GITHUB_ENV
            echo "BUILD_PATH_RELATIVE=DemoApp.xcworkspace" >> $GITHUB_ENV
            echo "‚úÖ Using workspace"
          else
            echo "BUILD_TYPE=-project" >> $GITHUB_ENV
            echo "BUILD_PATH_RELATIVE=DemoApp.xcodeproj" >> $GITHUB_ENV
            echo "‚úÖ Using project"
          fi
          echo "SCHEME=DemoAppSwift" >> $GITHUB_ENV

      - name: Resolve Swift Package dependencies (retry)
        run: |
          set -euo pipefail
          cd Example
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Resolving packages"
            if xcodebuild -resolvePackageDependencies \
              $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
              -scheme "$SCHEME"; then
              exit 0
            fi
            sleep $((i*10))
          done
          exit 1

      - name: Create + Boot iPhone 16 (iOS 18.2) simulator
        run: |
          set -euo pipefail

          RUNTIME_ID="com.apple.CoreSimulator.SimRuntime.iOS-18-2"
          DEVICE_TYPE="com.apple.CoreSimulator.SimDeviceType.iPhone-16"

          # Find an existing iPhone 16 on iOS 18.2
          EXISTING_UDID=$(xcrun simctl list devices --json | python3 - <<'PY'
import json,sys
data=json.load(sys.stdin)
target_runtime="com.apple.CoreSimulator.SimRuntime.iOS-18-2"
for rt, devices in data.get("devices", {}).items():
    if rt != target_runtime:
        continue
    for d in devices:
        if d.get("name") == "iPhone 16":
            print(d.get("udid",""))
            sys.exit(0)
print("")
PY
)

          if [ -z "${EXISTING_UDID:-}" ]; then
            echo "No iPhone 16 (iOS 18.2) found, creating one..."
            UDID=$(xcrun simctl create "iPhone 16" "$DEVICE_TYPE" "$RUNTIME_ID")
          else
            echo "Found existing iPhone 16 (iOS 18.2): $EXISTING_UDID"
            UDID="$EXISTING_UDID"
          fi

          echo "SIMULATOR_ID=$UDID" >> $GITHUB_ENV
          echo "DESTINATION_SPEC=platform=iOS Simulator,id=$UDID" >> $GITHUB_ENV

          echo "Booting simulator $UDID..."
          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b || true

          echo "üéØ Destination: platform=iOS Simulator,id=$UDID"

      - name: Install xcpretty (optional)
        run: |
          if ! command -v xcpretty &> /dev/null; then
            gem install xcpretty || true
          fi

      - name: Build for testing
        run: |
          set -o pipefail
          cd Example

          echo "üî® Building for testing: $SCHEME"
          echo "üéØ Destination: $DESTINATION_SPEC"

          xcodebuild build-for-testing \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION_SPEC" \
            -derivedDataPath ../DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            IPHONEOS_DEPLOYMENT_TARGET=18.2 \
            | (command -v xcpretty &> /dev/null && xcpretty --color || cat)

      - name: Run UI Tests
        run: |
          set -o pipefail
          cd Example

          echo "üß™ Running UI tests: $SCHEME"
          echo "üéØ Destination: $DESTINATION_SPEC"

          xcodebuild test-without-building \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION_SPEC" \
            -derivedDataPath ../DerivedData \
            -only-testing:DemoAppUITests/DemoAppUITests/testSchemaValidationFlow \
            -resultBundlePath ../DerivedData/TestResults.xcresult \
            IPHONEOS_DEPLOYMENT_TARGET=18.2 \
            | tee ../test-output.log | (command -v xcpretty &> /dev/null && xcpretty --color --report junit --output ../DerivedData/junit.xml || cat)

      - name: Print test output on failure
        if: failure()
        run: |
          echo "‚ùå ============ TEST FAILURE DETAILS ============"
          if [ -f test-output.log ]; then
            cat test-output.log
          else
            echo "No test-output.log found"
          fi
          echo "‚ùå ================================================"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            DerivedData/Logs/Test/*.xcresult
            DerivedData/junit.xml
            test-output.log
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action/macos@v2
        with:
          files: DerivedData/junit.xml
          check_name: UI Test Results
          comment_mode: off
        continue-on-error: true

