name: UI Tests

permissions:
  contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  ui-tests:
    name: Run DemoApp UI Tests
    runs-on: macos-15
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Prefer setting DEVELOPER_DIR over xcode-select for reliability on GH runners
    - name: Select Xcode (via DEVELOPER_DIR)
      run: |
        if [ -d "/Applications/Xcode_16.2.app" ]; then
          echo "DEVELOPER_DIR=/Applications/Xcode_16.2.app/Contents/Developer" >> $GITHUB_ENV
        elif [ -d "/Applications/Xcode_16.1.app" ]; then
          echo "DEVELOPER_DIR=/Applications/Xcode_16.1.app/Contents/Developer" >> $GITHUB_ENV
        elif [ -d "/Applications/Xcode_16.0.app" ]; then
          echo "DEVELOPER_DIR=/Applications/Xcode_16.0.app/Contents/Developer" >> $GITHUB_ENV
        else
          echo "No pinned Xcode found; using default Xcode"
        fi

    - name: Show Xcode version
      run: |
        echo "Using DEVELOPER_DIR=${DEVELOPER_DIR:-"(not set)"}"
        xcodebuild -version

    # Helpful diagnostics to quickly see if the iOS / iOS Simulator SDK is missing
    - name: Debug Xcode + SDKs
      run: |
        echo "DEVELOPER_DIR: ${DEVELOPER_DIR:-"(not set)"}"
        xcode-select -p
        echo "---- Xcodes in /Applications ----"
        ls -la /Applications | grep Xcode || true
        echo "---- SDKs ----"
        xcodebuild -showsdks || true
        echo "---- Platforms ----"
        ls -la "$(xcode-select -p)/Platforms" || true

    # If the selected Xcode is missing the iOS platform/SDK, attempt to download it
    - name: Install iOS platform (if missing)
      run: |
        set -e
        if ! xcodebuild -showsdks | grep -q "iOS Simulator"; then
          echo "iOS Simulator SDK missing ‚Äî downloading iOS platform..."
          xcodebuild -downloadPlatform iOS
        else
          echo "iOS Simulator SDK present."
        fi

    - name: Show available simulators
      run: xcrun simctl list devices available

    - name: Verify project structure
      run: |
        echo "üìã Verifying project structure..."
        if [ -f "Example/DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
          echo "‚úÖ Found workspace: Example/DemoApp.xcworkspace"
        elif [ -d "Example/DemoApp.xcodeproj" ]; then
          echo "‚úÖ Found project: Example/DemoApp.xcodeproj"
        else
          echo "‚ùå Project/workspace not found in Example/ directory"
          find . -name "*.xcworkspace" -o -name "*.xcodeproj" | head -10
          exit 1
        fi

    - name: List available schemes
      run: |
        cd Example
        if [ -f "DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
          echo "üìã Listing schemes from workspace..."
          xcodebuild -list -workspace DemoApp.xcworkspace
        else
          echo "üìã Listing schemes from project..."
          xcodebuild -list -project DemoApp.xcodeproj
        fi

    - name: Boot simulator
      run: |
        echo "üì± Finding available iPhone simulator..."

        if command -v jq &> /dev/null; then
          DEVICE_JSON=$(xcrun simctl list devices available --json 2>/dev/null || echo "")
          if [ -n "$DEVICE_JSON" ]; then
            DEVICE_ID=$(echo "$DEVICE_JSON" | jq -r '.devices | to_entries[] | .value[] | select(.name | test("iPhone (16|15|14|13)") and (test("Pro") | not)) | .udid' | head -1 || echo "")
            if [ -n "$DEVICE_ID" ]; then
              DEVICE_NAME=$(echo "$DEVICE_JSON" | jq -r --arg id "$DEVICE_ID" '.devices | to_entries[] | .value[] | select(.udid == $id) | .name' | head -1 || echo "")
              DEVICE_OS=$(echo "$DEVICE_JSON" | jq -r --arg id "$DEVICE_ID" '.devices | to_entries[] | .value[] | select(.udid == $id) | .runtime' | sed 's/.*iOS-\([0-9.]*\).*/iOS \1/' | head -1 || echo "")
            fi
          fi
        fi

        if [ -z "$DEVICE_ID" ]; then
          echo "Using text-based device detection..."
          DEVICE_INFO=$(xcrun simctl list devices available | grep -E "iPhone (16|15|14|13)" | grep -v "Pro" | head -1 || echo "")

          if [ -z "$DEVICE_INFO" ]; then
            echo "No available iPhone found, creating iPhone 15..."
            RUNTIME=$(xcrun simctl list runtimes available | grep "iOS" | head -1 | awk '{print $NF}' | tr -d '()' || echo "")
            if [ -n "$RUNTIME" ]; then
              DEVICE_ID=$(xcrun simctl create "Test iPhone" "iPhone 15" "$RUNTIME" 2>/dev/null || echo "")
              DEVICE_INFO=$(xcrun simctl list devices | grep "$DEVICE_ID" | head -1 || echo "")
            fi
          fi

          if [ -n "$DEVICE_INFO" ]; then
            DEVICE_ID=$(echo "$DEVICE_INFO" | grep -o "[0-9A-F-]\{36\}" | head -1)
            DEVICE_NAME=$(echo "$DEVICE_INFO" | sed -E 's/^[[:space:]]*([^(]+).*/\1/' | xargs)
            DEVICE_OS=$(echo "$DEVICE_INFO" | grep -oE "iOS [0-9.]+" | head -1 || echo "")
          fi
        fi

        if [ -z "$DEVICE_ID" ]; then
          echo "‚ùå Failed to find or create simulator"
          echo "Available devices:"
          xcrun simctl list devices available | head -20
          exit 1
        fi

        if [ -z "$DEVICE_NAME" ]; then
          DEVICE_NAME="iPhone 15"
        fi

        echo "SIMULATOR_ID=$DEVICE_ID" >> $GITHUB_ENV
        echo "SIMULATOR_NAME=$DEVICE_NAME" >> $GITHUB_ENV
        if [ -n "$DEVICE_OS" ]; then
          echo "SIMULATOR_OS=$DEVICE_OS" >> $GITHUB_ENV
        fi

        echo "‚úÖ Found simulator: $DEVICE_NAME (ID: $DEVICE_ID)"
        if [ -n "$DEVICE_OS" ]; then
          echo "   OS Version: $DEVICE_OS"
        fi

        echo "üöÄ Booting simulator..."
        xcrun simctl boot "$DEVICE_ID" 2>/dev/null || echo "Simulator already booted or booting..."

        sleep 5

        echo "‚úÖ Verifying simulator is available..."
        xcrun simctl list devices | grep "$DEVICE_ID" || echo "‚ö†Ô∏è Warning: Simulator may not be fully ready"

    - name: Set build configuration
      id: build-config
      run: |
        if [ -f "Example/DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
          echo "BUILD_TYPE=-workspace" >> $GITHUB_ENV
          echo "BUILD_PATH=Example/DemoApp.xcworkspace" >> $GITHUB_ENV
          echo "BUILD_PATH_RELATIVE=DemoApp.xcworkspace" >> $GITHUB_ENV
          echo "‚úÖ Using workspace: Example/DemoApp.xcworkspace"
        elif [ -d "Example/DemoApp.xcodeproj" ]; then
          echo "BUILD_TYPE=-project" >> $GITHUB_ENV
          echo "BUILD_PATH=Example/DemoApp.xcodeproj" >> $GITHUB_ENV
          echo "BUILD_PATH_RELATIVE=DemoApp.xcodeproj" >> $GITHUB_ENV
          echo "‚úÖ Using project: Example/DemoApp.xcodeproj"
        else
          echo "‚ùå No Xcode workspace or project found in Example/ directory!"
          exit 1
        fi

        echo "SCHEME=DemoAppSwift" >> $GITHUB_ENV
        echo "‚úÖ Using scheme: DemoAppSwift"

    - name: Install xcpretty (optional)
      run: |
        if ! command -v xcpretty &> /dev/null; then
          echo "xcpretty not found, installing..."
          gem install xcpretty || echo "Failed to install xcpretty, will use plain output"
        else
          echo "xcpretty is already installed"
        fi

    # Key change: use destination by UDID (most reliable); no xcodebuild showdestinations parsing needed
    - name: Set destination (by UDID)
      run: |
        echo "DESTINATION_SPEC=platform=iOS Simulator,id=$SIMULATOR_ID" >> $GITHUB_ENV
        echo "üéØ Final destination spec: platform=iOS Simulator,id=$SIMULATOR_ID"

    - name: Build for testing
      run: |
        set -o pipefail
        cd Example

        echo "üî® Building for testing with scheme: $SCHEME"
        echo "üìÇ Build path: $BUILD_PATH_RELATIVE"
        echo "üéØ Destination: $DESTINATION_SPEC"

        if command -v xcpretty &> /dev/null; then
          xcodebuild build-for-testing \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION_SPEC" \
            -derivedDataPath ../DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            | xcpretty --color || cat
        else
          xcodebuild build-for-testing \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION_SPEC" \
            -derivedDataPath ../DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY=""
        fi

    - name: Run UI Tests
      run: |
        set -o pipefail
        cd Example

        echo "üß™ Running UI tests with scheme: $SCHEME"
        echo "üìÇ Build path: $BUILD_PATH_RELATIVE"
        echo "üéØ Destination: $DESTINATION_SPEC"

        if command -v xcpretty &> /dev/null; then
          xcodebuild test-without-building \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION_SPEC" \
            -derivedDataPath ../DerivedData \
            -only-testing:DemoAppUITests/DemoAppUITests/testSchemaValidationFlow \
            -resultBundlePath ../DerivedData/TestResults.xcresult \
            | tee ../test-output.log | xcpretty --color --report junit --output ../DerivedData/junit.xml
        else
          xcodebuild test-without-building \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION_SPEC" \
            -derivedDataPath ../DerivedData \
            -only-testing:DemoAppUITests/DemoAppUITests/testSchemaValidationFlow \
            -resultBundlePath ../DerivedData/TestResults.xcresult \
            | tee ../test-output.log
        fi
      continue-on-error: false

    - name: Print test output on failure
      if: failure()
      run: |
        echo "‚ùå ============ TEST FAILURE DETAILS ============"
        if [ -f test-output.log ]; then
          cat test-output.log
        else
          echo "No test output log found at test-output.log"
          echo "Checking for test results..."
          ls -la DerivedData/Logs/Test/ 2>/dev/null || echo "No test logs directory found"
        fi
        echo "‚ùå ================================================"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          DerivedData/Logs/Test/*.xcresult
          DerivedData/junit.xml
          test-output.log
        retention-days: 30

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: |
          DerivedData/Logs/Test/**/*.log
          ~/Library/Logs/DiagnosticReports/
        retention-days: 7

    - name: Publish test results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action/macos@v2
      with:
        files: DerivedData/junit.xml
        check_name: UI Test Results
        comment_mode: off
      continue-on-error: true

