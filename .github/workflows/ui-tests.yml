name: UI Tests

permissions:
  contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  ui-tests:
    name: Run DemoApp UI Tests
    runs-on: macos-14
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode (via DEVELOPER_DIR)
        run: |
          if [ -d "/Applications/Xcode_16.2.app" ]; then
            echo "DEVELOPER_DIR=/Applications/Xcode_16.2.app/Contents/Developer" >> $GITHUB_ENV
          elif [ -d "/Applications/Xcode_16.1.app" ]; then
            echo "DEVELOPER_DIR=/Applications/Xcode_16.1.app/Contents/Developer" >> $GITHUB_ENV
          elif [ -d "/Applications/Xcode_16.0.app" ]; then
            echo "DEVELOPER_DIR=/Applications/Xcode_16.0.app/Contents/Developer" >> $GITHUB_ENV
          else
            echo "No pinned Xcode found; using default Xcode"
          fi

      - name: Make root use the same Xcode
        run: |
          set -euo pipefail
          if [ -n "${DEVELOPER_DIR:-}" ]; then
            echo "Switching root xcode-select to: $DEVELOPER_DIR"
            sudo xcode-select -s "$DEVELOPER_DIR"
          else
            echo "DEVELOPER_DIR not set; using system default Xcode"
          fi
          sudo xcodebuild -version
          sudo xcodebuild -license accept || true

      - name: Show Xcode version
        run: |
          echo "Using DEVELOPER_DIR=${DEVELOPER_DIR:-"(not set)"}"
          xcodebuild -version

      - name: Xcode first launch setup
        run: |
          sudo env DEVELOPER_DIR="${DEVELOPER_DIR:-}" xcodebuild -runFirstLaunch || sudo xcodebuild -runFirstLaunch

      - name: üîé Xcode & Simulator Diagnostics
        run: |
          echo "===== XCODE SELECT ====="
          xcode-select -p
          echo

          echo "===== XCODE VERSION ====="
          xcodebuild -version
          echo

          echo "===== INSTALLED SDKs ====="
          xcodebuild -showsdks || true
          echo

          echo "===== INSTALLED SIMULATOR RUNTIMES ====="
          xcrun simctl list runtimes || true
          echo

      - name: Verify iOS Simulator SDK exists (fail fast)
        run: |
          set -euo pipefail
          if ! xcodebuild -showsdks | grep -q "iOS Simulator"; then
            echo "‚ùå iOS Simulator SDK is missing in this Xcode. Can't run UI tests on this runner."
            exit 1
          fi
          echo "‚úÖ iOS Simulator SDK is present."

      - name: Verify project structure
        run: |
          echo "üìã Verifying project structure..."
          if [ -f "Example/DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
            echo "‚úÖ Found workspace: Example/DemoApp.xcworkspace"
          elif [ -d "Example/DemoApp.xcodeproj" ]; then
            echo "‚úÖ Found project: Example/DemoApp.xcodeproj"
          else
            echo "‚ùå Project/workspace not found in Example/ directory"
            find . -name "*.xcworkspace" -o -name "*.xcodeproj" | head -10
            exit 1
          fi

      - name: Resolve Swift Package dependencies (retry)
        run: |
          set -euo pipefail
          cd Example
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Resolving packages"
            if xcodebuild -resolvePackageDependencies \
                -workspace DemoApp.xcworkspace \
                -scheme DemoAppSwift; then
              exit 0
            fi
            sleep $((i*10))
          done
          exit 1

      - name: List available schemes
        run: |
          cd Example
          xcodebuild -list -workspace DemoApp.xcworkspace

      - name: Boot simulator (best-effort)
        run: |
          set -euo pipefail
          xcrun simctl boot "iPhone 15" 2>/dev/null || true
          sleep 5
          xcrun simctl list devices booted || true

      - name: Set build configuration
        run: |
          if [ -f "Example/DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
            echo "BUILD_TYPE=-workspace" >> $GITHUB_ENV
            echo "BUILD_PATH_RELATIVE=DemoApp.xcworkspace" >> $GITHUB_ENV
          elif [ -d "Example/DemoApp.xcodeproj" ]; then
            echo "BUILD_TYPE=-project" >> $GITHUB_ENV
            echo "BUILD_PATH_RELATIVE=DemoApp.xcodeproj" >> $GITHUB_ENV
          else
            echo "‚ùå No Xcode workspace or project found in Example/ directory!"
            exit 1
          fi
          echo "SCHEME=DemoAppSwift" >> $GITHUB_ENV

      - name: Install xcpretty (optional)
        run: |
          if ! command -v xcpretty &> /dev/null; then
            gem install xcpretty || true
          fi

      # Pick a destination that exists AND is compatible with your test target.
      # Since DemoAppUITests requires iOS Simulator 18.5+ in your log, we:
      # 1) prefer an iPhone simulator with OS >= 18.5 if available
      # 2) otherwise we fall back to "highest available iPhone OS" but ALSO override deployment target to 17.0 in CI
      - name: Set destination (pick newest iPhone simulator)
        run: |
          set -euo pipefail
          cd Example

          OUT=$(xcodebuild -showdestinations -workspace DemoApp.xcworkspace -scheme DemoAppSwift)
          echo "$OUT"

          CANDIDATES=$(echo "$OUT" | grep -E "platform:iOS Simulator, id:.*name:iPhone" || true)
          if [ -z "$CANDIDATES" ]; then
            echo "‚ùå No iPhone simulator destinations found"
            exit 1
          fi

          BEST=$(python3 - <<'PY'
import re, sys
lines = sys.stdin.read().splitlines()

def vt(s):
    return tuple(int(x) for x in s.strip().split("."))

parsed = []
for line in lines:
    m_os = re.search(r'OS:([^,}]+)', line)
    m_name = re.search(r'name:([^,}]+)', line)
    if not (m_os and m_name):
        continue
    os_ver = m_os.group(1).strip()
    name = m_name.group(1).strip()
    try:
        ver = vt(os_ver)
    except Exception:
        continue
    parsed.append((ver, name, os_ver))

if not parsed:
    raise SystemExit(1)

# Prefer OS >= 18.5 if present
min_ok = (18, 5)
eligible = [p for p in parsed if p[0] >= min_ok]
pick = max(eligible, key=lambda x: x[0]) if eligible else max(parsed, key=lambda x: x[0])

print(f"{pick[1]}|{pick[2]}")
PY
<<< "$CANDIDATES")

          NAME="${BEST%%|*}"
          OS="${BEST##*|}"

          echo "DESTINATION_SPEC=platform=iOS Simulator,name=$NAME,OS=$OS" >> $GITHUB_ENV
          echo "üéØ Final destination spec: platform=iOS Simulator,name=$NAME,OS=$OS"

      - name: Build for testing
        run: |
          set -o pipefail
          cd Example

          echo "üî® Building for testing with scheme: $SCHEME"
          echo "üéØ Destination: $DESTINATION_SPEC"

          # Override deployment target so CI can run on available simulators even if the UITest target is set too high.
          if command -v xcpretty &> /dev/null; then
            xcodebuild build-for-testing \
              $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
              -scheme "$SCHEME" \
              -destination "$DESTINATION_SPEC" \
              -derivedDataPath ../DerivedData \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              IPHONEOS_DEPLOYMENT_TARGET=17.0 \
              | xcpretty --color || cat
          else
            xcodebuild build-for-testing \
              $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
              -scheme "$SCHEME" \
              -destination "$DESTINATION_SPEC" \
              -derivedDataPath ../DerivedData \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              IPHONEOS_DEPLOYMENT_TARGET=17.0
          fi

      - name: Run UI Tests
        run: |
          set -o pipefail
          cd Example

          echo "üß™ Running UI tests with scheme: $SCHEME"
          echo "üéØ Destination: $DESTINATION_SPEC"

          # Same override here
          if command -v xcpretty &> /dev/null; then
            xcodebuild test-without-building \
              $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
              -scheme "$SCHEME" \
              -destination "$DESTINATION_SPEC" \
              -derivedDataPath ../DerivedData \
              -only-testing:DemoAppUITests/DemoAppUITests/testSchemaValidationFlow \
              -resultBundlePath ../DerivedData/TestResults.xcresult \
              IPHONEOS_DEPLOYMENT_TARGET=17.0 \
              | tee ../test-output.log | xcpretty --color --report junit --output ../DerivedData/junit.xml
          else
            xcodebuild test-without-building \
              $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
              -scheme "$SCHEME" \
              -destination "$DESTINATION_SPEC" \
              -derivedDataPath ../DerivedData \
              -only-testing:DemoAppUITests/DemoAppUITests/testSchemaValidationFlow \
              -resultBundlePath ../DerivedData/TestResults.xcresult \
              IPHONEOS_DEPLOYMENT_TARGET=17.0 \
              | tee ../test-output.log
          fi

      - name: Print test output on failure
        if: failure()
        run: |
          echo "‚ùå ============ TEST FAILURE DETAILS ============"
          if [ -f test-output.log ]; then
            cat test-output.log
          else
            echo "No test-output.log found"
          fi
          echo "‚ùå ================================================"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            DerivedData/Logs/Test/*.xcresult
            DerivedData/junit.xml
            test-output.log
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action/macos@v2
        with:
          files: DerivedData/junit.xml
          check_name: UI Test Results
          comment_mode: off
        continue-on-error: false

