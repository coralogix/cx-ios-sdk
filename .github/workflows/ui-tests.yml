name: UI Tests

permissions:
  contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  ui-tests:
    name: Run DemoApp UI Tests
    runs-on: macos-15 # macOS 15 (Sequoia) with Xcode 16+
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      checks: write 
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: |
        # Try to find available Xcode versions
        if [ -d "/Applications/Xcode_16.2.app" ]; then
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
        elif [ -d "/Applications/Xcode_16.1.app" ]; then
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
        elif [ -d "/Applications/Xcode_16.0.app" ]; then
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
        else
          echo "Using default Xcode version"
        fi
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Show available simulators
      run: xcrun simctl list devices available
      
    - name: Verify project structure
      run: |
        echo "üìã Verifying project structure..."
        if [ -f "Example/DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
          echo "‚úÖ Found workspace: Example/DemoApp.xcworkspace"
        elif [ -d "Example/DemoApp.xcodeproj" ]; then
          echo "‚úÖ Found project: Example/DemoApp.xcodeproj"
        else
          echo "‚ùå Project/workspace not found in Example/ directory"
          find . -name "*.xcworkspace" -o -name "*.xcodeproj" | head -10
          exit 1
        fi
        
    - name: List available schemes
      run: |
        cd Example
        if [ -f "DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
          echo "üìã Listing schemes from workspace..."
          xcodebuild -list -workspace DemoApp.xcworkspace
        else
          echo "üìã Listing schemes from project..."
          xcodebuild -list -project DemoApp.xcodeproj
        fi
      
    - name: Boot simulator
      run: |
        # Try to find an available iPhone simulator
        DEVICE_ID=$(xcrun simctl list devices available | grep -E "iPhone (16|15|14|13)" | grep -v "Pro" | head -1 | grep -o "[0-9A-F-]\{36\}" || echo "")
        
        if [ -z "$DEVICE_ID" ]; then
          echo "Creating new iPhone 15 simulator..."
          DEVICE_ID=$(xcrun simctl create "Test iPhone" "iPhone 15" 2>/dev/null || echo "")
        fi
        
        if [ -z "$DEVICE_ID" ]; then
          echo "‚ùå Failed to find or create simulator"
          xcrun simctl list devices available
          exit 1
        fi
        
        echo "SIMULATOR_ID=$DEVICE_ID" >> $GITHUB_ENV
        echo "‚úÖ Using simulator: $DEVICE_ID"
        xcrun simctl boot "$DEVICE_ID" 2>/dev/null || echo "Simulator already booted"
        
    - name: Set build configuration
      id: build-config
      run: |
        # Prefer workspace over project
        if [ -f "Example/DemoApp.xcworkspace/contents.xcworkspacedata" ]; then
          echo "BUILD_TYPE=-workspace" >> $GITHUB_ENV
          echo "BUILD_PATH=Example/DemoApp.xcworkspace" >> $GITHUB_ENV
          echo "BUILD_PATH_RELATIVE=DemoApp.xcworkspace" >> $GITHUB_ENV
          echo "‚úÖ Using workspace: Example/DemoApp.xcworkspace"
        elif [ -d "Example/DemoApp.xcodeproj" ]; then
          echo "BUILD_TYPE=-project" >> $GITHUB_ENV
          echo "BUILD_PATH=Example/DemoApp.xcodeproj" >> $GITHUB_ENV
          echo "BUILD_PATH_RELATIVE=DemoApp.xcodeproj" >> $GITHUB_ENV
          echo "‚úÖ Using project: Example/DemoApp.xcodeproj"
        else
          echo "‚ùå No Xcode workspace or project found in Example/ directory!"
          exit 1
        fi
        
        # Explicitly set the scheme to DemoAppSwift
        echo "SCHEME=DemoAppSwift" >> $GITHUB_ENV
        echo "‚úÖ Using scheme: DemoAppSwift"
        
    - name: Install xcpretty (optional)
      run: |
        if ! command -v xcpretty &> /dev/null; then
          echo "xcpretty not found, installing..."
          gem install xcpretty || echo "Failed to install xcpretty, will use plain output"
        else
          echo "xcpretty is already installed"
        fi
      
    - name: Build for testing
      run: |
        set -o pipefail
        cd Example
        
        # Get simulator name from ID
        SIMULATOR_NAME=$(xcrun simctl list devices | grep "$SIMULATOR_ID" | head -1 | sed 's/.*(\(.*\))/\1/' | xargs || echo "iPhone 15")
        
        echo "üî® Building for testing with scheme: $SCHEME"
        echo "üì± Using simulator: $SIMULATOR_NAME (ID: $SIMULATOR_ID)"
        echo "üìÇ Build path: $BUILD_PATH_RELATIVE"
        
        if command -v xcpretty &> /dev/null; then
          xcodebuild build-for-testing \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
            -derivedDataPath ../DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            | xcpretty --color || cat
        else
          xcodebuild build-for-testing \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
            -derivedDataPath ../DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY=""
        fi
          
    - name: Run UI Tests
      run: |
        set -o pipefail
        cd Example
        
        echo "üß™ Running UI tests with scheme: $SCHEME"
        echo "üì± Using simulator: $SIMULATOR_ID"
        echo "üìÇ Build path: $BUILD_PATH_RELATIVE"
        
        if command -v xcpretty &> /dev/null; then
          xcodebuild test-without-building \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
            -derivedDataPath ../DerivedData \
            -only-testing:DemoAppUITests/DemoAppUITests/testSchemaValidationFlow \
            -resultBundlePath ../DerivedData/TestResults.xcresult \
            | tee ../test-output.log | xcpretty --color --report junit --output ../DerivedData/junit.xml || true
        else
          xcodebuild test-without-building \
            $BUILD_TYPE "$BUILD_PATH_RELATIVE" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
            -derivedDataPath ../DerivedData \
            -only-testing:DemoAppUITests/DemoAppUITests/testSchemaValidationFlow \
            -resultBundlePath ../DerivedData/TestResults.xcresult \
            | tee ../test-output.log || true
        fi
      continue-on-error: false
      
    - name: Print test output on failure
      if: failure()
      run: |
        echo "‚ùå ============ TEST FAILURE DETAILS ============"
        if [ -f test-output.log ]; then
          cat test-output.log
        else
          echo "No test output log found at test-output.log"
          echo "Checking for test results..."
          ls -la DerivedData/Logs/Test/ 2>/dev/null || echo "No test logs directory found"
        fi
        echo "‚ùå ================================================"
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          DerivedData/Logs/Test/*.xcresult
          DerivedData/junit.xml
          test-output.log
        retention-days: 30
          
    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: |
          DerivedData/Logs/Test/**/*.log
          ~/Library/Logs/DiagnosticReports/
        retention-days: 7
        
    - name: Publish test results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action/macos@v2
      with:
        files: DerivedData/junit.xml
        check_name: UI Test Results
        comment_mode: off
      continue-on-error: true
